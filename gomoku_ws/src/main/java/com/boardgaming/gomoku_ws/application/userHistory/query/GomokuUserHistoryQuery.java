package com.boardgaming.gomoku_ws.application.userHistory.query;

import com.boardgaming.common.exception.user.NotFoundUserException;
import com.boardgaming.domain.user.domain.User;
import com.boardgaming.domain.userHistory.domain.GomokuUserHistory;
import com.boardgaming.domain.userHistory.domain.repository.GomokuUserHistoryCustomRepository;
import com.boardgaming.domain.userHistory.domain.repository.GomokuUserHistoryRepository;
import com.boardgaming.domain.userHistory.dto.response.GomokuUserHistoryResponse;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Collection;
import java.util.Comparator;

@Service
@Transactional(readOnly = true)
public class GomokuUserHistoryQuery {
    private final GomokuUserHistoryRepository gomokuUserHistoryRepository;
    private final GomokuUserHistoryCustomRepository gomokuUserHistoryCustomRepository;
    private final Long defaultRating;

    public GomokuUserHistoryQuery(
        final GomokuUserHistoryRepository gomokuUserHistoryRepository,
        final GomokuUserHistoryCustomRepository gomokuUserHistoryCustomRepository,
        @Value("${gomoku.setting.defaultRating}") final Long defaultRating
    ) {
        this.gomokuUserHistoryRepository = gomokuUserHistoryRepository;
        this.gomokuUserHistoryCustomRepository = gomokuUserHistoryCustomRepository;
        this.defaultRating = defaultRating;
    }

    public Long getUserRating(final User user) {
        return gomokuUserHistoryRepository.findByUserId(user.getId())
                .map(GomokuUserHistory::getRating)
                .orElseGet(() -> gomokuUserHistoryRepository.save(
                        GomokuUserHistory.builder()
                                .userId(user.getId())
                                .rating(defaultRating)
                                .build()
                ).getRating());
    }

    public String getLowBlackPlayRateUserId(final Collection<String> userIds) {
        String lowBlackPlayRateUserId = gomokuUserHistoryRepository.findByUserIdIn(userIds)
            .stream()
            .sorted(Comparator.comparing(GomokuUserHistory::getBlackPlayRate))
            .map(GomokuUserHistory::getUserId)
            .toList()
            .get(0);

        return userIds.stream()
            .filter(userId -> userId.equals(lowBlackPlayRateUserId))
            .findAny()
            .orElseThrow(NotFoundUserException::new);
    }

    public GomokuUserHistoryResponse getGomokuUserHistory(final String userId) {
        return gomokuUserHistoryCustomRepository.findByUserId(userId);
    }
}
